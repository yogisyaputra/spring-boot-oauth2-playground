# Redirect HTTP → HTTPS
server {
    listen 80;
    server_name api.example.com;
    return 301 https://$host$request_uri;
}

# HTTPS entry
server {
    listen 443 ssl http2;
    server_name api.example.com;

    # ==== TLS (Let’s Encrypt) ====
    ssl_certificate     /etc/letsencrypt/live/api.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.example.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # ==== Security headers ====
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    # Sesuaikan CSP dengan FE kamu (jangan block script/style yang dipakai)
    add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: https:; script-src 'self'; style-src 'self' 'unsafe-inline'" always;

    # ==== Gzip (optional) ====
    gzip on;
    gzip_types text/plain text/css application/json application/javascript application/xml+rss;
    gzip_min_length 1024;

    # ==== Rate limit (optional, terutama endpoint auth/OAuth) ====
    # limit_req_zone $binary_remote_addr zone=api_rl:10m rate=10r/m;

    # ==== Proxy ke Spring Boot ====
    location / {
        # limit_req zone=api_rl burst=20 nodelay; # aktifkan kalau pakai limit

        proxy_pass http://127.0.0.1:8080;

        proxy_http_version 1.1;
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;

        # Upgrade (WebSocket, kalau diperlukan)
        proxy_set_header Upgrade            $http_upgrade;
        proxy_set_header Connection         $connection_upgrade;

        # Timeouts/buffer (tune sesuai kebutuhan)
        proxy_connect_timeout   60s;
        proxy_send_timeout      60s;
        proxy_read_timeout      60s;
        client_max_body_size    1m;
    }

    # (Opsional) health check ringan
    location = /healthz { return 200 "ok"; add_header Content-Type text/plain; }
}
